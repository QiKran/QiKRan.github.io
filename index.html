<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Kran</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Kran">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Kran">
<meta property="og:description" content="blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="QiKran">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Kran" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kran</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-SpringMVC-控制器测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/SpringMVC-%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-07-15T01:39:42.563Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/SpringMVC-%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B5%8B%E8%AF%95/">SpringMVC-控制器测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-MVC-控制层单元测试"><a href="#Spring-MVC-控制层单元测试" class="headerlink" title="Spring MVC 控制层单元测试"></a>Spring MVC 控制层单元测试</h1><h2 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h2><p>导入如下的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="单一控制器测试"><a href="#单一控制器测试" class="headerlink" title="单一控制器测试"></a>单一控制器测试</h2><ol>
<li>针对某一个控制器来构建 MockMvc 对象，如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pxxy.springmvc.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.pxxy.springmvc.BaseTests;</span><br><span class="line"><span class="keyword">import</span> com.pxxy.springmvc.config.WebMvcConfig;</span><br><span class="line"><span class="keyword">import</span> org.mockito.MockitoAnnotations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.testng.AbstractTestNGSpringContextTests;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.web.WebAppConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.testng.annotations.BeforeMethod;</span><br><span class="line"><span class="keyword">import</span> org.testng.annotations.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.setup.MockMvcBuilders.standaloneSetup;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.setup.MockMvcBuilders.webAppContextSetup;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.testng.Assert.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = WebMvcConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">WebAppConfiguration</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RestfulControllerTest</span> <span class="keyword">extends</span> <span class="title">AbstractTestNGSpringContextTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//如果需要调用业务层和持久层，则需要自动注入控制器对象</span></span><br><span class="line">    <span class="keyword">private</span> RestfulController restfulController;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext wac;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化 mockMvc, 使用单一控制器的测试环境</span></span><br><span class="line">        mockMvc = standaloneMockMvcBuilder(restfulController).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetBookById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//模拟请求并执行、然后验证结果</span></span><br><span class="line">        <span class="keyword">this</span>.mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/rest/book/69"</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk());</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="WEB集成环境："><a href="#WEB集成环境：" class="headerlink" title="WEB集成环境："></a>WEB集成环境：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration</span>(classes = WebMvcConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">WebAppConfiguration</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RestfulControllerTest</span> <span class="keyword">extends</span> <span class="title">AbstractTestNGSpringContextTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//如果需要调用业务层和持久层，则需要自动注入控制器对象</span></span><br><span class="line">    <span class="keyword">private</span> RestfulController restfulController;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext wac;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化 mockMvc, 使用WEB集成测试环境</span></span><br><span class="line">        mockMvc = webAppContextSetup(wac).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetBookById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//模拟请求并执行、然后验证结果</span></span><br><span class="line">        <span class="keyword">this</span>.mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/rest/book/69"</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk());</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="有关测试相关的API"><a href="#有关测试相关的API" class="headerlink" title="有关测试相关的API"></a>有关测试相关的API</h2><ol>
<li>MockMvc  用来测试控制层的入口 接口</li>
<li><strong>MockMvcBuilders</strong>  用来构建 MockMvc 的工具类</li>
<li>RequestBuilder   请求构建器，通过它可以来发送各种不同类型的请求</li>
<li><strong>MockMvcRequestBuilders</strong>  用来构建<code>RequestBuilder</code> 的构建器工具类，通过此类可以去发送各种不同的请求，如：get,post, put, delete,…</li>
<li>ResultActions   通过mockMvc的perform方法来获取此对象，它主要有三个方法：<ul>
<li>andExpect(ResultMatcher matcher)   用为比较请求执行的结果与预期是否相符</li>
<li>andDo(ResultHandler handler)   对请求执行的结果做进一步的操作</li>
<li>andReturn()  -&gt; MvcResult,  直接返回请求的结果</li>
</ul>
</li>
<li>ResultMatcher  接口， 用来匹配结果的，有工具类：<strong>MockMvcResultMatchers</strong></li>
<li><strong>MockMvcResultMatchers</strong>  工具类，用来生成 ResultMatcher 的</li>
<li>ResultHandler 接口</li>
<li><strong>MockMvcResultHandlers</strong>  工具类，用来生成 ResultHandler 的</li>
<li>MvcResult 接口</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/SpringMVC-%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B5%8B%E8%AF%95/" data-id="ckcmpx862000ncghc4spwd1pi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring+mybatis整合" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/Spring+mybatis%E6%95%B4%E5%90%88/" class="article-date">
  <time datetime="2020-07-15T01:39:42.561Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/Spring+mybatis%E6%95%B4%E5%90%88/">Spring+mybatis整合</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring框架与Mybatis的整合"><a href="#Spring框架与Mybatis的整合" class="headerlink" title="Spring框架与Mybatis的整合"></a>Spring框架与Mybatis的整合</h1><blockquote>
<p>实际上，MyBatis应该和IOC容器一起使用，否则，我们在业务层中就要与持久层的API耦合在一起，这显然是不合理的，所以，通过IOC容器我就可以把这个耦合度降到最低。</p>
<p>Spring 框架提供了IOC容器，所以，mybatis框架和spring整合就是很自然的事情。</p>
</blockquote>
<h2 id="mybatis如何与spring整合"><a href="#mybatis如何与spring整合" class="headerlink" title="mybatis如何与spring整合"></a>mybatis如何与spring整合</h2><ol>
<li>导入依赖<ul>
<li>mybatis框架的依赖</li>
<li>mybatis-spring 的依赖 【两者整合需要的依赖】</li>
</ul>
</li>
<li>选定整合的方式<ul>
<li>纯 xml 配置</li>
<li>纯 注解配置   [<strong>优先</strong>]<ul>
<li>@MapperScan   用来扫描指定的Mapper所在包</li>
</ul>
</li>
<li>xml + 注解 配置</li>
</ul>
</li>
</ol>
<h2 id="具体的写法"><a href="#具体的写法" class="headerlink" title="具体的写法"></a>具体的写法</h2><h3 id="xml-配置"><a href="#xml-配置" class="headerlink" title="xml 配置"></a>xml 配置</h3><ol>
<li>准备 mybatis-config.xml 文件，注：此文件不需要再写数据源相关的配置【由spring来配置】</li>
<li>写 Spring的配置类</li>
<li>在spring的配置类，配置好 datasource 和 事务管理器后，再配置 SqlSessionFactoryBean </li>
<li>每一个Mapper都要对应一个 方法，并在此方法上打上  @Bean 注解</li>
</ol>
<h3 id="Spring采用注解-mybatis-xml配置"><a href="#Spring采用注解-mybatis-xml配置" class="headerlink" title="Spring采用注解+mybatis xml配置"></a>Spring采用注解+mybatis xml配置</h3><p>涉及到相关的要点：</p>
<ol>
<li><p>配置sqlSessionFactory, 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactory</span><span class="params">(@Autowired  DataSource dataSource)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建 由 mybatis-spring 组件提供的 SqlSessoinFactoryBean 对象</span></span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        <span class="comment">//设置 数据源 和配置文件的位置</span></span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">//读取配置文件</span></span><br><span class="line">        bean.setConfigLocation(<span class="keyword">new</span> ClassPathResource(<span class="string">"mybatis-config.xml"</span>));</span><br><span class="line">        <span class="comment">//返回</span></span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注：在此方法中，需要指定 mybatis-config.xml 的位置</p>
</li>
<li><p>mybatis-config.xml 文件中，不需要配置 environments ,如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 全局设置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.pxxy.springmvc.entity"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span></span></span><br><span class="line"><span class="tag">                                <span class="attr">javaType</span>=<span class="string">"com.pxxy.springmvc.entity.UserStatus"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 读取映射文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mapper/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mapper/AccountMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写相应的Mapper接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pxxy.springmvc.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.pxxy.springmvc.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****</span></span><br><span class="line"><span class="comment"> * 用户数据的持久层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">save</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(Serializable id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(Serializable id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findByUserName</span><span class="params">(String userName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>写 mybatis的mapper映射文件，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.pxxy.springmvc.mapper.UserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"save"</span> <span class="attr">parameterType</span>=<span class="string">"user"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        insert into t_user(id,user_name,password,mobile_phone,real_name,</span><br><span class="line">                           create_date,update_date,last_login_date,status,avatar_url)</span><br><span class="line">        values</span><br><span class="line">        (null,#&#123;userName&#125;, #&#123;password&#125;, #&#123;mobilePhone&#125;, #&#123;realName&#125;,</span><br><span class="line">         now(),now(), #&#123;lastLoginDate&#125;,</span><br><span class="line">         #&#123;status, typeHandler=org.apache.ibatis.type.EnumOrdinalTypeHandler&#125;, #&#123;avatarUrl&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"delete"</span> <span class="attr">parameterType</span>=<span class="string">"integer"</span>&gt;</span></span><br><span class="line">        delete from t_user where id = #&#123;value&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        update t_user</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"set"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span>   <span class="comment">&lt;!-- 相当于 &lt;set&gt; --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span>password = #&#123;password&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"realName != null"</span>&gt;</span>real_name = #&#123;realName&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"mobilePhone != null"</span>&gt;</span>mobile_phone = #&#123;mobilePhone&#125; ,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span>status = #&#123;status&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"avatarUrl != null"</span>&gt;</span>avatar_url = #&#123;avatarUrl&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            update_date = now()</span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        select * from t_user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByUserName"</span> <span class="attr">resultType</span>=<span class="string">"user"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span>&gt;</span></span><br><span class="line">        select * from t_user where user_name = #&#123;value&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findById"</span> <span class="attr">resultType</span>=<span class="string">"user"</span> <span class="attr">parameterType</span>=<span class="string">"integer"</span>&gt;</span></span><br><span class="line">        select * from t_user where id = #&#123;value&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>要想把Mybatis中的xxxMapper纳入到 Spring IOC的管理之中，需要做：</p>
<ul>
<li><p>单一管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserMapper <span class="title">userMapper</span><span class="params">(@Autowired SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">        SqlSessionTemplate template = <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> template.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>扫描整个包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"com.pxxy.springmvc.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>













</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/Spring+mybatis%E6%95%B4%E5%90%88/" data-id="ckcmpx862000mcghc20dhfed3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring MVC-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/Spring%20MVC-3/" class="article-date">
  <time datetime="2020-07-15T01:39:42.559Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/Spring%20MVC-3/">Spring MVC-3</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h1><h2 id="请求参数的值以集合来封装"><a href="#请求参数的值以集合来封装" class="headerlink" title="请求参数的值以集合来封装"></a>请求参数的值以集合来封装</h2><ol>
<li><p>针对前台表单页面中的复选框或多行选择框，我们希望以集合的类型来接收这些数据。</p>
<p>如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"get|post"</span> <span class="attr">action</span>=<span class="string">"/user/update.do"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"hobby"</span> <span class="attr">value</span>=<span class="string">"1"</span>&gt;</span>Movie</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"hobby"</span> <span class="attr">value</span>=<span class="string">"2"</span>&gt;</span>Code</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"hobby"</span> <span class="attr">value</span>=<span class="string">"3"</span>&gt;</span>Game</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">假设上面三个复选框都被选中，那么传递到后台，我们可以通过一个 List 来接收这个请求参数 hobby</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user/update.do"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(@RequestParam(<span class="string">"hobby"</span>)</span> List&lt;Integer&gt; hobby) </span>&#123;</span><br><span class="line">    <span class="comment">//注：此处由我们写的是接口，所以，要使用 @RequestParam 注解。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注：如果前面采用AJAX 异步发送请求，并且数据是以 json格式发送，那么，后台我们的参数上面要打上另一个注解：@RequestBody</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>针对所有的请求参数，我们不想通过实体类/Bean 来接收，而想以Map来接收</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"get|post"</span> <span class="attr">action</span>=<span class="string">"add.do"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"stuno"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以单个参数来接收</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/add.do"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(String name, <span class="keyword">int</span> age, String stuno)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//以map来接收</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/add.do"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//还可以使用JAVABEAN来接收</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/add.do"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(Student student)</span> </span>&#123; <span class="comment">//很显然,Student实体类中包含以上3个属性</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="AJAX请求的处理"><a href="#AJAX请求的处理" class="headerlink" title="AJAX请求的处理"></a>AJAX请求的处理</h2><blockquote>
<p>针对服务端来讲，我们的控制器中的方法就不能返回一个逻辑视图名或真正视图路径。它要求当前方法要以返回值做为响应客户端的内容。这时就需要使用 <strong>@ResponseBody</strong> 注解</p>
<p>此注解一般要配合 @RequestMapping(value=””, produces=”响应给客户端的内容MIME格式”)</p>
<p>比如：我们想给客户端返回一个json，则 produces=”application/json”</p>
</blockquote>
<h3 id="GET或POST方式请求数据的获取"><a href="#GET或POST方式请求数据的获取" class="headerlink" title="GET或POST方式请求数据的获取"></a>GET或POST方式请求数据的获取</h3><blockquote>
<p>我们通过AJAX发送请求给服务端，可以通过 GET方式也可以通过POST方式，其中：</p>
<ol>
<li>通过 GET 方式，采用请求头来传递数据，这种方式传递的数据不能太大，否则会被截取。</li>
<li>通过 POST 方式，采用请求体来传递数据，对数据大小没有限制。</li>
</ol>
<p>对于后端代码来说，不管你是采用GET还是POST，它的处理方式是一样的。不同在于前端的代码不同，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET 方式：</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">     url: <span class="string">"$&#123;pageContext.request.contextPath&#125;/book/deleteSelect.do?"</span>+queryData,</span><br><span class="line">     method: <span class="string">"GET"</span>,</span><br><span class="line">     <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">     dataType: <span class="string">"text"</span>,   <span class="comment">//表示期望服务端返回给我们的数据格式</span></span><br><span class="line">     success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">               <span class="comment">//成功</span></span><br><span class="line">               alert(data);</span><br><span class="line">               <span class="comment">//重新加载本页面</span></span><br><span class="line">               <span class="built_in">window</span>.location.reload();</span><br><span class="line">     &#125;,</span><br><span class="line">     error: <span class="function"><span class="keyword">function</span> (<span class="params">jqXHR</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 失败</span></span><br><span class="line">                alert(<span class="string">"删除失败了"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<p>如果是 POST，则：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST 方式：</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">     url: <span class="string">"$&#123;pageContext.request.contextPath&#125;/book/deleteSelect.do"</span>,</span><br><span class="line">     method: <span class="string">"POST"</span>,</span><br><span class="line">     data: queryDaa,  </span><br><span class="line">     <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">     dataType: <span class="string">"text"</span>,   <span class="comment">//表示期望服务端返回给我们的数据格式</span></span><br><span class="line">     success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">               <span class="comment">//成功</span></span><br><span class="line">               alert(data);</span><br><span class="line">               <span class="comment">//重新加载本页面</span></span><br><span class="line">               <span class="built_in">window</span>.location.reload();</span><br><span class="line">     &#125;,</span><br><span class="line">     error: <span class="function"><span class="keyword">function</span> (<span class="params">jqXHR</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 失败</span></span><br><span class="line">                alert(<span class="string">"删除失败了"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>


</blockquote>
<h3 id="如果前端采用JSON数据传递到后台，后台该如何获取这个数据？"><a href="#如果前端采用JSON数据传递到后台，后台该如何获取这个数据？" class="headerlink" title="如果前端采用JSON数据传递到后台，后台该如何获取这个数据？"></a>如果前端采用JSON数据传递到后台，后台该如何获取这个数据？</h3><blockquote>
<p>与上面采用请求参数或表单参数不同的时，前端如果采用json来传递数据到后台，则后台的Controller中的方法参数应该使用 <code>@RequestBody</code> 来修饰，而不是 <code>@RequestParam</code> . 如下：</p>
<ol>
<li>前端</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST 方式：</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">     url: <span class="string">"$&#123;pageContext.request.contextPath&#125;/book/deleteSelect.do"</span>,</span><br><span class="line">     method: <span class="string">"POST"</span>,</span><br><span class="line">     data: josnData,   <span class="comment">//必需是 json字符串  </span></span><br><span class="line">     <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">     dataType: <span class="string">"text"</span>,   <span class="comment">//表示期望服务端返回给我们的数据格式</span></span><br><span class="line">     contentType: <span class="string">"application/json"</span>,</span><br><span class="line">     success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">               <span class="comment">//成功</span></span><br><span class="line">               alert(data);</span><br><span class="line">               <span class="comment">//重新加载本页面</span></span><br><span class="line">               <span class="built_in">window</span>.location.reload();</span><br><span class="line">     &#125;,</span><br><span class="line">     error: <span class="function"><span class="keyword">function</span> (<span class="params">jqXHR</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 失败</span></span><br><span class="line">                alert(<span class="string">"删除失败了"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>后端</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/deleteSelect.do"</span>, produces = <span class="string">"text/html;charset=utf-8"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span>  <span class="comment">//以内容来响应客户端</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deleteSelected</span><span class="params">(@RequestBody List&lt;Integer&gt; idList)</span> </span>&#123;</span><br><span class="line">       log.debug(<span class="string">"Spring MVC帮助封装了请求参数 idList："</span>+idList);</span><br><span class="line">       <span class="comment">//调用业务方法</span></span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.bookService.deleteSelected(idList) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"删除成功"</span>;  <span class="comment">//这个返回值 会写回到 客户端</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"删除失败"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="文件上传和下载"><a href="#文件上传和下载" class="headerlink" title="文件上传和下载"></a>文件上传和下载</h2><h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><blockquote>
<p>首先，需要在 配置类中定义 <code>MultipartResolver</code>, 这个是接口，我们在代码要生成它的实现类的对象，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个 CommonsMultipartResolver</span></span><br><span class="line">        CommonsMultipartResolver multipartResolver =</span><br><span class="line">                                <span class="keyword">new</span> CommonsMultipartResolver();</span><br><span class="line">        <span class="comment">//配置属性</span></span><br><span class="line">        multipartResolver.setMaxUploadSize(<span class="number">2</span>*<span class="number">1024</span>*<span class="number">1025</span>); <span class="comment">//最大2M</span></span><br><span class="line">        multipartResolver.setMaxUploadSizePerFile(<span class="number">2</span>*<span class="number">1024</span>*<span class="number">1024</span>); <span class="comment">//每个文件大小</span></span><br><span class="line">        <span class="comment">//返回</span></span><br><span class="line">        <span class="keyword">return</span> multipartResolver;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其次，文件上传需要引入第三方的依赖，如下：【这里我们选用了 commons-fileupload】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第三， 在前端页面的表单中，必需指定 enctype属性的值为：<code>multipart/form-data</code></p>
<p>第四，在后端的控制器方法中，必需使用 MultipartFile 参数来接收 文件上传域，其中，文件上传域的name与此参数名一样，如果不一样，则需要使用 <code>@RequestParam</code> 来指定。</p>
<p>第五， 在方法体中，使用 MultipartFile 的方法来完成 上传操作。</p>
</blockquote>
<h3 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h3><blockquote>
<p>要点：</p>
<ol>
<li><p>必需指定自确的 contentType 类型，不同的文件格式，需要指定不同的 contentType,如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    response.setContentType(<span class="string">"images/png;charset=utf-8"</span>);</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定另一个头，告诉浏览器，如果你能在线打开，就打开，否则生成下载弹出框。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不缓存数据时，要设置的响应头</span></span><br><span class="line">response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"No-cache"</span>);</span><br><span class="line">response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"No-cache"</span>);</span><br><span class="line">response.setDateHeader(<span class="string">"Expires"</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">response.setHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment;filename="</span> + fileName);</span><br></pre></td></tr></table></figure>
</li>
<li><p>利用 输入和输出流完成下载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用Spring提代的工具类：</span></span><br><span class="line">FileCopyUtils.copy(本地要被下载的文件的输入流， response.getOutputStream());</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<h2 id="Bean的验证"><a href="#Bean的验证" class="headerlink" title="Bean的验证"></a>Bean的验证</h2><blockquote>
<p>也就是针对表单域中的输入项进行后台的有效验证。</p>
<p>因为纯前端的JS验证很容易被“跳过”，所以，完全依赖于前端的验证是不能防止数据风险的。</p>
<p>Spring MVC 的Bean验证需要依赖 Hibernate Validator 组件。</p>
</blockquote>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><ol>
<li><p>导入 Hibernate Validator 组件</p>
<blockquote>
<p>Hibernate Validator 是 JAVAEE 的Bean Validation规范的实现者。</p>
</blockquote>
</li>
<li><p>在 Spring MVC的配置类中，重写父类的 验证器方法</p>
</li>
<li><p>编写验证属性文件，这个属性文件的文件名由三部份组成：</p>
<ul>
<li>baseName</li>
<li>国家和语言的代号</li>
<li>扩展名</li>
</ul>
<p>如：beanValidation_ZH_CN.properties, beanValidation_EN.properties</p>
</li>
<li><p>把你需要做验证的JAVABEAN，打开  Bean Validation的注解。</p>
</li>
</ol>
<h3 id="Spring-MVC的控制器方法返回json对象"><a href="#Spring-MVC的控制器方法返回json对象" class="headerlink" title="Spring MVC的控制器方法返回json对象"></a>Spring MVC的控制器方法返回json对象</h3><p>支持两种方式</p>
<ol>
<li><p>自己把对象解析成 json 字符串，并返回 【不建议使用】</p>
<blockquote>
<p>比如我们可以导入 fastjson 依赖，并利用它的API 把任意JAVA对象转解成 JSON 字符串。</p>
<p>然后，在方法的@RequestMapping注解中，指定 produces=”application/json”  或 produces=”text/json”</p>
</blockquote>
</li>
<li><p>利用Spring 自带的功能，自动转换 【推荐】</p>
<blockquote>
<p>要求：</p>
<ul>
<li><p>导入 jackson 相关依赖，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用spring自带的json处理依赖包 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>在你的控制器方法中，需要在  @RequestMapping中指定 produces=”application/json” 。</strong></p>
</li>
</ul>
</blockquote>
</li>
</ol>
<h2 id="拦截器-Interceptor"><a href="#拦截器-Interceptor" class="headerlink" title="拦截器 Interceptor"></a>拦截器 Interceptor</h2><blockquote>
<ol>
<li>写一个类实现 HandlerIntercepter 接口或者继承 HandlerIntercepterAdapter 类。</li>
<li>重写相关的方法，主要有如下三个方法：<ul>
<li>preHandle()    表示在目标控制器的方法调用之前被调用</li>
<li>postHandle()   表示在目标控制器的方法调用之后被调用【此时响应并没有到达客户端】</li>
<li>afterCompletion()  表示当响应结束后再调用此方法</li>
</ul>
</li>
</ol>
</blockquote>
<p>XML的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">"/**"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.pxxy.springmvc.interceptor.PerformanceLogInterceptor"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注： 这个文件需要在 配置类中去读取。</p>
<p><strong>代码的配置：</strong></p>
<p>在 <code>WebMvcConfig</code>配置类中，重写父类的 <code>addInterceptors</code> 方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> PerformanceLogInterceptor()).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><ol>
<li><p>单个控制器中的异常处理</p>
<ul>
<li><p>在你想做异常处理的控制器里面，添加一个方法来处理异常，并且使用 @ExceptionHandler 来修饰，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(value = RuntimeException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">handlerException</span>(<span class="title">Exception</span> <span class="title">ex</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//此Controller中，任一个打上了 @RequestMapping的方法出现 RuntimeException 异常时，就会回调此方法</span></span><br><span class="line">        System.out.println(<span class="string">"-- BookContorller的handlerException方法被调用了..."</span>);</span><br><span class="line">        System.out.println(<span class="string">"ex = "</span> + ex);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//上面应该做好异常日志</span></span><br><span class="line">        <span class="comment">//下面就是跳转到一个指定 的友好页面 [500.jsp]</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在此类中，无论哪个被请求执行的方法在运行过程中出现了 <code>RuntimeException</code> 异常，Spring MVC框架都会去执行 上面的方法。</p>
</li>
</ul>
</li>
</ol>
<ol start="2">
<li><p>全局的异常处理</p>
<ul>
<li><p>写一个类实现<code>HandlerExceptionResolver</code> 接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pxxy.springmvc.handlers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerExceptionResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/********************</span></span><br><span class="line"><span class="comment"> * 处理异常的第二种方式：</span></span><br><span class="line"><span class="comment"> * 可以实现全局的异常处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> <span class="keyword">implements</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         HttpServletResponse response, Object handler, Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">final</span> String requestURI = request.getRequestURI();</span><br><span class="line">        <span class="keyword">final</span> Object login_user = request.getSession().getAttribute(<span class="string">"LOGIN_USER"</span>);</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"造成异常的处理类："</span>+handler.getClass());</span><br><span class="line">        System.out.println(<span class="string">"异常信息："</span>+e.getClass()+<span class="string">" =&gt; "</span>+ e.getMessage());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.addObject(<span class="string">"EX_MSG"</span>, e.getMessage());</span><br><span class="line">        mv.setViewName(<span class="string">"forward:/static/500.jsp"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>在 配置类中，要扫描这个类所在的包。</strong></p>
</li>
</ul>
</li>
</ol>
<h2 id="有关Restful-风格的URL"><a href="#有关Restful-风格的URL" class="headerlink" title="有关Restful 风格的URL"></a>有关Restful 风格的URL</h2><blockquote>
<p>Restful 是采用了请求的Method来表达请求的意图，实际上，所有的请求，对于数据来说，无非就是4种，也就是增、删、 改、查，或者说：CRUD 操作。</p>
<p>而请求的method刚好可以满足这些操作，我们分别以：</p>
<ul>
<li>GET 请求代表 获取，也就是查</li>
<li>POST 请求代表 给予，也就是 增</li>
<li>PUT 请求代表 放，也就是 更新</li>
<li>DELETE 请示代表 删除，也就是删除</li>
</ul>
<p>所以，我们在URI的设计中，完全可以利用这个动词来表示用户的意愿，如：</p>
<p>GET  /book/1      代表 获取id为1的 图书</p>
<p>DELETE /book/1   代表 删除id为1 的图书</p>
<p>…</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/Spring%20MVC-3/" data-id="ckcmpx861000lcghcgiqr31l7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-spring MVC-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/spring%20MVC-2/" class="article-date">
  <time datetime="2020-07-15T01:39:42.557Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/spring%20MVC-2/">spring MVC-2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h1><h2 id="控制器的开发"><a href="#控制器的开发" class="headerlink" title="控制器的开发"></a>控制器的开发</h2><p>步骤：</p>
<ol>
<li>写一个类，打上 @Controller 注解即可【即不需要继承HttpServlet，也不需要实现Spring 提供的任何接口】</li>
<li>编写响应方法，在响应方法上面打上 @RequestMapping 注解，指定 url-pattern,  这个url-pattern 不能重复。</li>
</ol>
<p>如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/user/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理完成后，跳转到 list.jsp</span></span><br><span class="line">        <span class="comment">//1. 调用业务层的方法，去获取所有的用户对象</span></span><br><span class="line">        List&lt;User&gt; userList = userService.findAll();</span><br><span class="line">        <span class="comment">//2.绑定对象到请求范围 </span></span><br><span class="line">        <span class="comment">//request.setAttribte("USER_LIST_KEY", userList);</span></span><br><span class="line">        model.addAttribute(<span class="string">"USER_LIST_KEY"</span>, userList);</span><br><span class="line">        <span class="comment">//3. 跳转  [此处返回的只是一个逻辑视图名，而SpringMVC默认的视图解析器是 jsp]</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"list"</span>;  <span class="comment">//自动会翻译成 list.jsp</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/user/toUpdate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toUpdate</span><span class="params">(@RequestParam Integer id,Model model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//2.调用业务方法</span></span><br><span class="line">        User user = userService.findById(id);</span><br><span class="line">        <span class="comment">//3.绑定</span></span><br><span class="line">        model.addAttribute(<span class="string">"USER_KEY"</span>, user);</span><br><span class="line">        <span class="comment">//4. 跳转</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"update"</span>; <span class="comment">//update.jsp </span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/user/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 直接调用业务方法</span></span><br><span class="line">        userService.update(user);</span><br><span class="line">        <span class="comment">//返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"list"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="视图解析器"><a href="#视图解析器" class="headerlink" title="视图解析器"></a>视图解析器</h2><blockquote>
<p>默认情况下，Spring MVC采用JSP为默认视图解析器,  配置如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        log.debug(<span class="string">"调用了 configureViewResolvers 方法，配置视图解析器"</span>);</span><br><span class="line">        InternalResourceViewResolver irvr = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">        <span class="comment">//设置属性</span></span><br><span class="line">        irvr.setPrefix(<span class="string">"/WEB-INF/jsp/"</span>);</span><br><span class="line">        irvr.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">        irvr.setViewClass(JstlView<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">//默认也是 JstlView, 也就是 jsp</span></span><br><span class="line">        irvr.setContentType(<span class="string">"text/html;charset=utf-8"</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        registry.viewResolver(irvr);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注：如果我们不配置这个视图解析器，那么在控制器的方法中，就不能返回一个逻辑视图名，而应该返回完整的视图的文件名，如：”login.jsp”</p>
<p>在视图解析器， 有两个类型需要理解：</p>
<ol>
<li>视图解析器，一般以 Resolvers 结束， 如：<code>InternalResourceViewResolver,</code> 它其实是对 View 一个封装，它聚合了 View 对象。</li>
<li>视图渲染器，也就是真正的View处理者，它的顶级接口就是 <code>View</code>, 而我们上面使用的 <code>JstlView</code>是其中的一个实现，是针对jsp文件视图的实现。</li>
</ol>
<h2 id="请求和响应的处理"><a href="#请求和响应的处理" class="headerlink" title="请求和响应的处理"></a>请求和响应的处理</h2><h3 id="单一请求参数的处理"><a href="#单一请求参数的处理" class="headerlink" title="单一请求参数的处理"></a>单一请求参数的处理</h3><blockquote>
<p>我们可以在控制器的方法中，直接定义一个参数，这个参数名与前端页面的请求参数名称保持一致，这样，Spring MVC就会自动获取获取这个请求参数，并直接当做方法的参数的传入。 类型我们可以自定。</p>
<p>如果请求参数的名字与你的方法参数名不一样，则我们可以通过 <code>@RequestParam</code> 注解来指定请求参数名。</p>
</blockquote>
<h3 id="多个请求参数的处理"><a href="#多个请求参数的处理" class="headerlink" title="多个请求参数的处理"></a>多个请求参数的处理</h3><blockquote>
<p>同单一参数一样，Spring MVC框架同样可以帮助我们传入。</p>
</blockquote>
<h3 id="表单域的整体处理"><a href="#表单域的整体处理" class="headerlink" title="表单域的整体处理"></a>表单域的整体处理</h3><blockquote>
<p>当表单域有多个输入项时，我们不必定义很多个参来接收，而是考虑使用一个JavaBean对象来整体接收。</p>
<p>只要这个JavaBean中的属性名与表单域的name值保持一致即可。</p>
<p>同时，Spring Mvc支持多级属性的处理。</p>
</blockquote>
<h3 id="请求的转发和重定向"><a href="#请求的转发和重定向" class="headerlink" title="请求的转发和重定向"></a>请求的转发和重定向</h3><blockquote>
<p>如果不想让我们的方法返字符串被当做逻辑视图名，则可以在字符串前面加上<code>forward:</code>和<code>redirect:</code> </p>
<p>加上<code>forward:</code> 表示转发</p>
<p>加上<code>redirect:</code> 表示重定向</p>
<p>如果返回字符串没有添加这两个前缀中的任何一个，则表示转发请求，同时会经过视图解析器。</p>
<p><strong>注：上面的规则是我们的控制器方法中没有使用 <code>@ResponseBody</code> 注解，如果使用了这个注解，则表示此方法的返回值被当做响应客户端的内容。而不是一个逻辑视图名或路径名。</strong></p>
</blockquote>
<h3 id="文件上传和下载的处理"><a href="#文件上传和下载的处理" class="headerlink" title="文件上传和下载的处理"></a>文件上传和下载的处理</h3><h3 id="响应格式的设置"><a href="#响应格式的设置" class="headerlink" title="响应格式的设置"></a>响应格式的设置</h3><h2 id="注解的理解"><a href="#注解的理解" class="headerlink" title="注解的理解"></a>注解的理解</h2><p>@Controller   表示此类是一个控制器组件/Bean</p>
<p>@RequestMapping   用来指定此方法对应的请求url</p>
<p>@ResponseBody   以方法的返回值做为响应体</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/spring%20MVC-2/" data-id="ckcmpx87k001kcghc6yckaoi5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring MVC-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/Spring%20MVC-1/" class="article-date">
  <time datetime="2020-07-15T01:39:42.555Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/Spring%20MVC-1/">Spring MVC-1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h1><blockquote>
<p>它是一个 JAVA WEB 的框架，相比 Servlet， 它的开发更为便捷，提供了 前置控制器，以及请求、响应的封装，同时，不像Servlet只能写 doGet、doPost方法，在Spring MVC中，每一个控制器都可以定义多个方法，并且每个方法都可以定义 url.</p>
</blockquote>
<h2 id="前置控制器"><a href="#前置控制器" class="headerlink" title="前置控制器"></a>前置控制器</h2><blockquote>
<p>DispatcherServlet, 它本身就是一个 Servlet, 并且还实现了 <strong>ApplicationContextAware</strong> 接口, 这意味着在这个前置控制器，被会注入 应用上下文[<strong>ApplicationContext</strong>]. 它的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring mvc 主控制器,前置控制器，也叫 大C  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.pxxy.springmvc.config.WebMvcConfig<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="Spring-MVC的开发步骤"><a href="#Spring-MVC的开发步骤" class="headerlink" title="Spring MVC的开发步骤"></a>Spring MVC的开发步骤</h2><p>前提： web.xml 配置成功.</p>
<ol>
<li><p>开发一个 <code>WebMvcConfig.java</code> 的配置类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pxxy.springmvc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> yejf</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span>   <span class="comment">//表示此类是Spring框架的配置类</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.pxxy.springmvc.controller"</span>)</span><br><span class="line"><span class="meta">@EnableWebMvc</span> <span class="comment">//启动 Spring MVC</span></span><br><span class="line"><span class="meta">@Import</span>(AppConfig<span class="class">.<span class="keyword">class</span>)   //如有需要，则导入业务层和持久层</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(WebMvcConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebMvcConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"WebMvcConfig被创建了...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/******</span></span><br><span class="line"><span class="comment">     * 重写此方法，用来告诉前置控制器 放行我们指定的静态资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"调用了 addResourceHandlers 方法，放行 /static和/public 两个静态资源路径"</span>);</span><br><span class="line">        <span class="comment">//放行 static下的所有资源</span></span><br><span class="line">        registry.addResourceHandler(<span class="string">"/static/**"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"/static/"</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/public/**"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"classpath:/public/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>开发控制器, 写一个普通的java类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pxxy.springmvc.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> yejf</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span>   <span class="comment">//相当于 @Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        System.out.println(<span class="string">"请求调用了 HelloController的hello()方法..."</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        response.setContentType(<span class="string">"text/html;charset=utf-8"</span>);</span><br><span class="line">        <span class="keyword">final</span> PrintWriter out = response.getWriter();</span><br><span class="line">        out.println(<span class="string">"&lt;h2&gt;欢迎访问hello方法&lt;/h2&gt;"</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署 web应用，启动服务，在浏览器输入地址：<a href="http://localhost:8080/appName/hello" target="_blank" rel="noopener">http://localhost:8080/appName/hello</a>  </p>
</li>
<li><p>如果要放行静态资源，请在<code>WebMvcConfig</code>类中重写接口的 <code>addResourceHandlers</code> 方法。详见第2步。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/Spring%20MVC-1/" data-id="ckcmpx860000jcghc7oja84cf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-spring框架-day03-事务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/spring%E6%A1%86%E6%9E%B6-day03-%E4%BA%8B%E5%8A%A1/" class="article-date">
  <time datetime="2020-07-15T01:39:42.553Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/spring%E6%A1%86%E6%9E%B6-day03-%E4%BA%8B%E5%8A%A1/">spring框架-day03-事务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-框架之事务处理"><a href="#Spring-框架之事务处理" class="headerlink" title="Spring 框架之事务处理"></a>Spring 框架之事务处理</h1><h2 id="AOP回顾"><a href="#AOP回顾" class="headerlink" title="AOP回顾"></a>AOP回顾</h2><ol>
<li>@EnableAspectJAutoProxy   开 启AOP</li>
<li>导入 spring-aspects 的依赖</li>
<li>开发Aspect类【Advice类】<ul>
<li>@Component    切面也要纳入Spring 容器的管理之中</li>
<li>@Aspect    表明自己是一个切面</li>
<li>@Order   明确此切面织入的优先级。</li>
<li>@PointCut 定义哪些目标要被织入切面</li>
<li>@Before(value=”定义execution表达式 | 写@PointCut指定的方法名()”)</li>
<li>@After(value=”定义execution表达式 | 写@PointCut指定的方法名()”)</li>
<li>@AfterReturning(value=”定义execution表达式 | 写@PointCut指定的方法名()”, returning=”result”)</li>
<li>@AfterThrowing(value=”定义execution表达式 | 写@PointCut指定的方法名()”, throwing=”ex”)</li>
<li>@Around(value=”定义execution表达式 | 写@PointCut指定的方法名()”)</li>
</ul>
</li>
</ol>
<h3 id="AOP代理对象的生成"><a href="#AOP代理对象的生成" class="headerlink" title="AOP代理对象的生成"></a>AOP代理对象的生成</h3><p>两种方式：</p>
<ol>
<li>基于JDK的代理， 默认值，可以通过在 @EnableAspectJAutoProxy(proxyTargetClass = true)  指定为 CGLIB</li>
<li>基于CGLIB的代理</li>
</ol>
<h2 id="IOC-的后置处理器"><a href="#IOC-的后置处理器" class="headerlink" title="IOC 的后置处理器"></a>IOC 的后置处理器</h2><ol>
<li>BeanFactoryPostProcessor   Bean工厂的后置处理器，在Bean工厂创建完成后，会回调此方法</li>
<li>BeanPostProcessor   JAVABEAN的后缀处理器，在javaBean创建完成后，会回调此接口中的方法</li>
</ol>
<h2 id="Spring-事务处理"><a href="#Spring-事务处理" class="headerlink" title="Spring 事务处理"></a>Spring 事务处理</h2><blockquote>
<p>Spring 的事务处理是基于AOP。</p>
<p>要想在Spring框架中进行事务处理，我们需要做如下步骤：</p>
<ol>
<li>开启AOP</li>
<li>开启事务处理</li>
<li>导入事务处理的依赖  spring-tx</li>
<li>Spring支持两种事务处理的方式<ul>
<li>编程式事务</li>
<li>申明式事务</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="Spring框架的事务管理平台"><a href="#Spring框架的事务管理平台" class="headerlink" title="Spring框架的事务管理平台"></a>Spring框架的事务管理平台</h3><blockquote>
<p>Spring框架通过事务管理平台来控制和管理所有接入的事务，支持各种不同的事务类型，比如:</p>
<ul>
<li><p>DataSourceTransactionManager</p>
<p>​             \- JdbcTransactionManager</p>
</li>
<li><p>HibernateTransactionManager</p>
</li>
<li><p>JpaTransactionManager</p>
</li>
<li><p>JtaTransactionManager</p>
</li>
</ul>
<p>以上四个事务管理器都实现了 <code>PlatformTransactionManager</code> 接口</p>
</blockquote>
<h3 id="Spring事务定义-TransactionDefinition"><a href="#Spring事务定义-TransactionDefinition" class="headerlink" title="Spring事务定义: TransactionDefinition"></a>Spring事务定义: TransactionDefinition</h3><blockquote>
<p>Spring框架从5个维度来定义事务，如下：</p>
<ol>
<li>事务的传播行为 propagation<ul>
<li>PROPAGAION_REQUIRED    默认值</li>
<li>PROPAGATION_REQUIRED_NEW</li>
<li>PROPAGATION_NEVER</li>
<li>PROPAGATION_MANDATORY</li>
<li>PROPAGATION_NOT_SUPPORTED</li>
<li>PROPAGATION_SUPPORTS</li>
<li>…</li>
</ul>
</li>
<li>事务的隔离级别  Isolation<ul>
<li>ISOLATION_DEFAULT</li>
<li>ISOLATION_READ_UNCOMMITTED</li>
<li>ISOLATION_READ_COMMITTED</li>
<li>ISOLATION_REPEATABLE_READ</li>
<li>ISOLATION_SERIALIZABLE</li>
</ul>
</li>
<li>事务的回滚规则    commit或rollback</li>
<li>事务是否只读   readonly</li>
<li>事务超时性   timeout</li>
</ol>
</blockquote>
<h3 id="什么是事务？"><a href="#什么是事务？" class="headerlink" title="什么是事务？"></a>什么是事务？</h3><ol>
<li>数据库事务， 就是一组相关的SQL操作。</li>
<li>业务层面的事务，就是一组相关的操作。</li>
</ol>
<p>不管是什么层面的事务，我们的目的是要保证事务的原子性【一起失败或一起失败】</p>
<h3 id="事务的四大特性"><a href="#事务的四大特性" class="headerlink" title="事务的四大特性"></a>事务的四大特性</h3><ol>
<li>原子性 Atomicity</li>
<li>一致性 Consistency</li>
<li>隔离性  Isolation</li>
<li>持久性  Durablity</li>
</ol>
<h3 id="如何利用Spring来帮助我们做事务管理"><a href="#如何利用Spring来帮助我们做事务管理" class="headerlink" title="如何利用Spring来帮助我们做事务管理"></a>如何利用Spring来帮助我们做事务管理</h3><ol>
<li><p>编程式事务</p>
<blockquote>
<p>利用 PlatformTransactionManager 或 具体的 TransactionTemplate 来做，这种做法要侵入式的，也就我们需要在代码中去手动开启和关闭事务[要么提交，要么回滚]</p>
<p>步骤：</p>
<ol>
<li><p>创建一个 DataSource, 假设我们使用  DruidDataSource</p>
</li>
<li><p>创建一个 DataSourceTransactionManager， 注入 DataSource</p>
</li>
<li><p>创建一个 TransactionTemplate, 注入 DataSourceTransactionManager</p>
</li>
<li><p>在你需要做事务控制的类型中，注入 TransactionTemplate, 然后， 就可以通过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启事务</span></span><br><span class="line">....</span><br><span class="line">    ...</span><br><span class="line"> <span class="comment">//提交事务</span></span><br><span class="line">    transactionTemplate.getTranactionManager().commit();</span><br></pre></td></tr></table></figure>


</li>
</ol>
</blockquote>
</li>
<li><p>申明式事务  [事务的定义可以通过注解来完成，无需编码】</p>
</li>
</ol>
<h3 id="事务案例"><a href="#事务案例" class="headerlink" title="事务案例"></a>事务案例</h3><ol>
<li>准备一个实体类 Account</li>
<li>定义 AccountDao 接口</li>
<li>使用jdbc技术来实现这个接口，建议采用Spring提供的JdbcTemplate</li>
<li>定义业务层接口 AccountService</li>
<li>实现业务层接口，在此层来添加事务处理【可以用编程式事务，也可以使用申明式事务】</li>
<li>单元测试</li>
</ol>
<h3 id="事务传播形为"><a href="#事务传播形为" class="headerlink" title="事务传播形为"></a>事务传播形为</h3><blockquote>
<p>在 TransactionDefinition 中，定义了 事务的传播形为，使用 Propagation枚举来定义，有如下常量值：</p>
<ul>
<li>REQUIRED  表示如果没有事务，则开启一个新的事务，如果有，则加入到此事务中，这个是默认值</li>
<li>REQUIRED_NEW  如果有事务，则开启开新的事务，外层事务挂起，直到内部事务结束后灰愎，如果没有事务，则开始新的事务</li>
<li>SUPPORTS  如果有事务，则加入到事务，没有事务，则不加入</li>
<li>NOT_SUPPORTED  不管外部有没有事务，都不参与。</li>
<li>MANDATORY  要求一定要有事务，如果没有，则抛出异常</li>
<li>NEVER  表示不支持事务，如果外部有事务，则抛出异常</li>
<li>NESTED  嵌套事务，利用 Savepoint 来完成的。</li>
</ul>
</blockquote>
<h3 id="Spring框架申明式事务的步骤"><a href="#Spring框架申明式事务的步骤" class="headerlink" title="Spring框架申明式事务的步骤"></a>Spring框架申明式事务的步骤</h3><ol>
<li>在 配置类中，使用 <code>@EnableTransactionManagement</code> 开启申明式事务</li>
<li>在 配置类中，要定义一个 <code>PlatformTransactionManager</code> 的 Bean</li>
<li>在业务层和持久层，使用 <strong>@Transactional</strong> 注解来定义事务的属性</li>
</ol>
<h3 id="编程式事务的代码结构"><a href="#编程式事务的代码结构" class="headerlink" title="编程式事务的代码结构"></a>编程式事务的代码结构</h3><ol>
<li>利用事务模板<code>TransactionTemplate</code></li>
<li>利用 平台事务管理器 <code>PlatformTransactionManager</code></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/spring%E6%A1%86%E6%9E%B6-day03-%E4%BA%8B%E5%8A%A1/" data-id="ckcmpx87k001lcghc1pvufwoi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-spring框架-day02-AOP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/spring%E6%A1%86%E6%9E%B6-day02-AOP/" class="article-date">
  <time datetime="2020-07-15T01:39:42.551Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/spring%E6%A1%86%E6%9E%B6-day02-AOP/">spring框架-day02-AOP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring框架之AOP"><a href="#Spring框架之AOP" class="headerlink" title="Spring框架之AOP"></a>Spring框架之AOP</h1><h2 id="回顾IOC"><a href="#回顾IOC" class="headerlink" title="回顾IOC"></a>回顾IOC</h2><ol>
<li>你来决定哪些对象由Spring IOC容器管理，被IOC容器管理的对象，就可以通过@Autowired 来自动注入。</li>
<li>需要明白常用注解的使用<ul>
<li>@Component</li>
<li>@Autowired</li>
<li>@Qualifier</li>
<li>@Resource</li>
<li>@Scope(value=”singleton”) 或：  @Scope(value=ConfigurableBeanFactory.SCOPE_SINGLETON)</li>
<li>@Lazy</li>
<li>@Configuration</li>
<li>@ComponentScan</li>
<li>@Import</li>
<li>@ImportResource</li>
</ul>
</li>
</ol>
<hr>
<h2 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h2><blockquote>
<p>Aspect Oriented Programming, 面向切面编程</p>
<p>关键词：切面[Aspect]</p>
</blockquote>
<h2 id="面向切面编程的基本概念"><a href="#面向切面编程的基本概念" class="headerlink" title="面向切面编程的基本概念"></a>面向切面编程的基本概念</h2><h3 id="切面-Aspect"><a href="#切面-Aspect" class="headerlink" title="切面 [Aspect]"></a>切面 [Aspect]</h3><blockquote>
<p>共同的附加功能点和切入的时机，合称为切面。</p>
<p>共同附加功能点可以是： 日志、验证、审核、认证、事务等…，它也被叫做 Advice【附加的功是什么， What】</p>
<p>切入的时机也叫 PointCut【切入点】，是针对目标类层面的过滤 【Where】。</p>
</blockquote>
<p>所以，<strong>Aspect=Advice + PointCut</strong></p>
<h3 id="Advice"><a href="#Advice" class="headerlink" title="Advice"></a>Advice</h3><blockquote>
<p>就是指切面要做的事情，也就是被织入的附加辅助代码【WHAT】</p>
</blockquote>
<h3 id="PointCut"><a href="#PointCut" class="headerlink" title="PointCut"></a>PointCut</h3><blockquote>
<p>就是指哪些目标类要被织入附加辅助代码。也就是指织入的地方在哪里【WHERE 】</p>
<p>它本质就是一段配置描述字符串，如：</p>
<p>execution * 包类.类名.*(..)</p>
</blockquote>
<h3 id="JoinPoint-【WHEN】"><a href="#JoinPoint-【WHEN】" class="headerlink" title="JoinPoint  【WHEN】"></a>JoinPoint  【WHEN】</h3><blockquote>
<p>连接点，这个是用来指定把附加辅助代码织入到目标对象的方法中的哪个位置的，Spring AOP支持如下位置：</p>
<ul>
<li>before    在目标对象的目标方法调用之前来执行 <strong>附加辅助代码【Advice】</strong></li>
<li>after       在目标对象的目标方法调用之后来执行 <strong>附加辅助代码【Advice】</strong>，不管目标方法是正常或异常返回</li>
<li>afterReturning    在目标对象的目标方法调用之后并正常返回后来执行 <strong>附加辅助代码【Advice】</strong></li>
<li>afterThrowing   在目标对象的目标方法调用之后并出现异常后来执行 <strong>附加辅助代码【Advice】</strong></li>
<li>around  环绕， 也就是上面四种情况的综合体。使用这个，那整个控制权就由程序员来定义了。</li>
</ul>
</blockquote>
<h3 id="织入-Weave"><a href="#织入-Weave" class="headerlink" title="织入[Weave]"></a>织入[Weave]</h3><blockquote>
<p>这是一个动作，是Spring 把附加辅助代码 “织入” 到 目标对象的目标方法的过程。</p>
<p>原理是采用代理来织入，而Spring 支持两种代理：</p>
<ul>
<li>JDK自带的Proxy 来生成代理。它只能对有接口的对象产生代码</li>
<li>基于CGLIB 来生成代理，这种功能强大，不需要接口的限制。</li>
</ul>
</blockquote>
<h2 id="Spring-AOP的配置步骤"><a href="#Spring-AOP的配置步骤" class="headerlink" title="Spring AOP的配置步骤"></a>Spring AOP的配置步骤</h2><ol>
<li>导入依赖，要使用AOP，还需要导入 spring-aspects 的依赖。</li>
<li>开启 AOP,  在配置类中，使用 @EnableAspectJAutoProxy 注解。</li>
<li>开发具体的 Advice 类， 使用： @Component 注解， @Aspect注解</li>
<li>通过连接点，来使用 PointCut</li>
</ol>
<h3 id="开发-Aspect"><a href="#开发-Aspect" class="headerlink" title="开发 Aspect"></a>开发 Aspect</h3><ol>
<li>写一个xxxAdvice 类或 xxxAspect,  打上：@Component 和 @Aspect 注解</li>
<li>在要被织入的方法中，使用 如下 注解来告诉 Spring框架，哪些目标类的目标方法会被织入。<ul>
<li>@After, 相当于是 @AfterRuturning 和 @AfterThrowing 的并集</li>
<li>@Before  </li>
<li>@AfterReturning   可以在注解中指定返回结果</li>
<li>@AfterThrowing    可以在注解中指定异常变量</li>
<li>@Around  环绕，以上四个综合体。功能更加强大</li>
</ul>
</li>
</ol>
<h3 id="PointCut的语法"><a href="#PointCut的语法" class="headerlink" title="PointCut的语法"></a>PointCut的语法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">execution([修饰符] 返回类型|* [包名.]类名.方法名|*(参数类型,[]|..))</span><br><span class="line">    </span><br><span class="line"><span class="comment">//如：</span></span><br><span class="line"><span class="comment">//以下的表达式表示CalcServiceImpl类中的所有方法，不考虑返回类型、修饰符和方法的参数列表</span></span><br><span class="line">execution(* com.pxxy.toturial.service.impl.CalcServiceImpl.*(..))  </span><br><span class="line">    </span><br><span class="line"><span class="comment">//</span></span><br><span class="line">execution(* com.pxxy.toturial.service.impl.*.*(..))</span><br></pre></td></tr></table></figure>



<h2 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h2><ul>
<li><p>JoinPoint </p>
<p>​    \- ProceedingJoinPoint</p>
<p>​                    proceed()   以目标方法的参数为准。</p>
<p>​                    proceed(Object[] args)   允许我们传入一组全新的参数给到目方法。要求参数的个数要与目标方法参数个数保持一致。</p>
<p>​                \- MethodInvocationProceedingJoinPoint    【使用的是这个实现类】</p>
<p>​                \-  JoinPointImpl</p>
</li>
<li><p>Signature</p>
<p>​        \- MemberSignature</p>
<p>​            \- CodeSignature</p>
<p>​                    \-  MethodSignature</p>
<p>​                                \-  MethodInvocationProceedingJoinPoint$MethodSignatureImpl</p>
</li>
</ul>
<h3 id="核心注解"><a href="#核心注解" class="headerlink" title="核心注解"></a>核心注解</h3><p>@Before(value=”可以直接写 execution代表的pointcut表达式 | 使用@PointCut 申明的 方法名”)</p>
<p>@After(value=”可以直接写 execution代表的pointcut表达式 | 使用@PointCut 申明的 方法名”)</p>
<p>@AfterReturning(value=”可以直接写 execution代表的pointcut表达式 | 使用@PointCut 申明的 方法名”, returning=”表示目标方法返回的计算结果”)</p>
<p>@AfterThrowing(value=”可以直接写 execution代表的pointcut表达式 | 使用@PointCut 申明的 方法名”, throwing=”异常变量”)</p>
<h2 id="IOC-和-AOP"><a href="#IOC-和-AOP" class="headerlink" title="IOC  和 AOP"></a>IOC  和 AOP</h2><blockquote>
<p>Spring 是通过 BeanFactory 来创建 被 IOC容器管理的对象的。其中，我们使用 ApplicationContext 就是一个BeanFactory, 所以，ClasspathXmlApplicationContext 和 AnnotationConfigApplicationContext 两个类都是BeanFactory 实现者。一个是基于XML的配置来实现Bean工厂， 一个是基于 注解的配置来实现Bean工厂。</p>
<p>后缀处理器,是Spring框架提供给程序员用来参与到Bean工厂或Bean的创建过程的一种机制，主要有如下接口：</p>
<ul>
<li><p>BeanFactoryPostProcessor,  针对BeanFactory的后置处理器</p>
</li>
<li><p>BeanPostProcessor    ， 针对Bean初始化完成后的后置处理器</p>
<p>​      \- ApplicationContextAwareProcessor</p>
<p>​      \-  ApplicationListenerDetector</p>
</li>
<li><p>ImportSelector</p>
</li>
</ul>
</blockquote>
<hr>
<p>作业：</p>
<p>1.写一个切面，用来统计后端的每一个业务方法执行的时长，以毫秒为单位。要求：目标业务方法执行之前显示一下时间，在目标方法调用完成后，再显示一下时间，并输出时间差。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/spring%E6%A1%86%E6%9E%B6-day02-AOP/" data-id="ckcmpx87i001icghccc75ek7f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-spring框架-day01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/spring%E6%A1%86%E6%9E%B6-day01/" class="article-date">
  <time datetime="2020-07-15T01:39:42.539Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/spring%E6%A1%86%E6%9E%B6-day01/">spring框架-day01</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<h1 id="Spring-框架-spring-framework"><a href="#Spring-框架-spring-framework" class="headerlink" title="Spring 框架[spring framework]"></a>Spring 框架[spring framework]</h1><blockquote>
<p>此框架是一个全功能性的框架，几乎涵盖了业务、持久层、MVC、安全、认证、分布式等等功能，并且是基于模块化的，每一个部份都可以单独使用，也可以很好地配合使用。</p>
<p>主要功能有：</p>
<ol>
<li>DI, 也叫IOC， 依赖注入/控制反转，这是Spring框架最核心的一个功能，后面的其它功能几乎都是基于此功能基础之上的。涉及到的组件有 spring-bean, spring-context, spring-core</li>
<li>AOP, 也叫面向切面编程。</li>
<li>DT， 也叫申明式事务编程</li>
<li>Spring MVC,  涵盖了WEB开发所需的所有技术组件，包括与各种视层图的集成，如:jsp, thymeleaf, velocity, Freemarker,…</li>
<li>持久层支持</li>
<li>国际化</li>
<li>Bean Validation</li>
<li>…</li>
</ol>
</blockquote>
<h2 id="Spring-大家庭"><a href="#Spring-大家庭" class="headerlink" title="Spring 大家庭"></a>Spring 大家庭</h2><ol>
<li>Spring Boot</li>
<li>Spring FrameWork</li>
<li>Spring Data</li>
<li>Spring Security</li>
<li>Spring Cloud</li>
<li>Spring Batch</li>
<li>…</li>
</ol>
<h2 id="框架怎么学？"><a href="#框架怎么学？" class="headerlink" title="框架怎么学？"></a>框架怎么学？</h2><p><strong>首先要理解框架的结构</strong></p>
<p>i18n,  bean validation, …</p>
<hr>
<p>Spring DT      Spring MVC     DATA Access  </p>
<hr>
<p>Spring AOP  </p>
<hr>
<p>Spring DI</p>
<p><strong>其次，要明白用它来干什么？</strong></p>
<p> DI 解决了对象的按需分配问题，意味着在Spring框架中，我们无需手动new对象，也无需去注册对象，Spring框架会帮助我们管理这些对象，并且按需分配。</p>
<p>AOP 解决了切面问题，把各个业务所需要的共性可以很好地抽离出来形成切面。</p>
<p>DT  解决了事务的配置处理，无需手动编码。</p>
<p>Spring MVC  解决了整个JAVA WEB开发的技术组件的整合问题。</p>
<p>Data Access  解决了以统一的方式来做DAO层，并且足够简单和高效。</p>
<p><strong>最后，学习核心API</strong> </p>
<h2 id="如何使用SpringFramework"><a href="#如何使用SpringFramework" class="headerlink" title="如何使用SpringFramework"></a>如何使用SpringFramework</h2><ol>
<li><p>准备一个 Maven 项目</p>
</li>
<li><p>导入 Spring framework相关的依赖, 这里我们导入： spring-context 的组件</p>
</li>
<li><p>针对Spring框架进行配置，支持两种方式</p>
<ul>
<li>xml 配置, 需要一个叫 applicationContext.xml 的配置文件</li>
<li>注解配置, 需要注解配置类</li>
<li>上面两者混用</li>
</ul>
</li>
<li><p>编写代码</p>
</li>
<li><p>做单元测试, Spring 内置了 junit 和 testng 的测试集成，我们可以任意选择，建议使用 testNG</p>
</li>
</ol>
<h2 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h2><ol>
<li><p>ApplicationContext 接口， 这个接口有多种实现类，如：</p>
<ul>
<li>ClasspathXmlApplicationContext   此实现类是要读取存在于类路径下的Spring配置文件而准备的。</li>
<li>FileSystemXmlApplicationContext  同上面一样，也是读到xml配置文件的，不同在于此类是基于文件系统的路径来读取的。</li>
<li>AnnotationConfigApplicationContext  此实现类是要读取Spring框架的配置类而准备的，我们使用注解配置时，就需要使用这个类。</li>
</ul>
</li>
</ol>
<h2 id="IOC容器"><a href="#IOC容器" class="headerlink" title="IOC容器"></a>IOC容器</h2><blockquote>
<p>IOC, Inverse Of Control, 控制反转，也叫 DI 【Dependency Injection， 依赖注入】, 通俗来说，就是需要使用某个对象时，由Spring 容器[Spring Container] 负责管理所有的JavaBean，然后按需分配。也就是当某个 对象需要另一个对象或多个对象时，只要这些对象都在Spring 容器当中，就可以自动注入。</p>
<p>Spring 容器在注入对象前，如何去找到目标对象：</p>
<ul>
<li>byType   在容器中按类型去检索</li>
<li>byName   在容器中按唯一性的标识符去检索。</li>
</ul>
</blockquote>
<h3 id="数据注入到对象中的方式"><a href="#数据注入到对象中的方式" class="headerlink" title="数据注入到对象中的方式"></a>数据注入到对象中的方式</h3><ul>
<li>通过 setter 来注入</li>
<li>通过构造器来注入</li>
</ul>
<h3 id="Spring-ioc容器中对象的创建"><a href="#Spring-ioc容器中对象的创建" class="headerlink" title="Spring ioc容器中对象的创建"></a>Spring ioc容器中对象的创建</h3><ol>
<li>默认情况下，采用单例模式，也就是说，每个Bean只创建1次。 如果想改变此形为，可以在 bean的定义中添加一个 scope=’prototype‘ 属性。 这样一来，我们每一次通过Spring IOC容器来获取对象时，Spring框架都会帮助我们重新创建新的对象。</li>
<li>默认情况下，Spring IOC容器没有采用延迟加载对象的策略，而是在容器启动后，就开始创建applicationContext.xml中定义的所有Bean对象，并且调用它们的init方法【如果有指定的话】。如果希望采用延迟加载，则只需要在 <bean>的定义中加入 lazy-init=”true” 即可</li>
</ol>
<h3 id="多配置文件的用法"><a href="#多配置文件的用法" class="headerlink" title="多配置文件的用法"></a>多配置文件的用法</h3><blockquote>
<p>在项目中，我们采用分层的思想，那spring的配置文件也可以分为多个，通过 <import resource=""/> 可以导入其它的配置文件。</p>
</blockquote>
<h2 id="注解配置"><a href="#注解配置" class="headerlink" title="注解配置"></a>注解配置</h2><ol>
<li><p>写一个配置类，这个类需要打上：</p>
<ul>
<li><p>@Configuration 注解</p>
</li>
<li><p>@ComponentScan</p>
<p>注：如果我们还需要自己去创建JavaBean被 Spring 容器管理的话，则可以在此配置类中添加方法，并且在此方法上面打上：@Bean  注解， 这样一来，这个方法的返回值 就会被容器所管理。</p>
</li>
</ul>
</li>
<li><p>在需要被注册为Spring IOC 容器管理的类型上面打上：</p>
<ul>
<li>@Component 注解</li>
</ul>
</li>
<li><p>在测试类中，就可以使用 AnnotationConfigApplicationContext 类来获取目标 Bean,并且调用它的方法。</p>
</li>
</ol>
<p>以上所涉及到的注解有：</p>
<ul>
<li>@Configuration       用来标明这是一个配置类</li>
<li>@ComponentScan     用来扫描指定的包，可以有多个</li>
<li>@Bean     用来修饰配置类中的方法的。</li>
<li>@Component    用来表示一个组件的【也就是JavaBean】</li>
<li>@Autowired   默认采用byType 来查找对象并注入。</li>
<li>@Qualifier(“具体的Bean的名字”)    当被注入对象存在多个的时候。</li>
<li>@javax.annotation.Resource   同样被Spring支持，能够通过 byType 或 byName 来查找目标Bean</li>
<li>@Import       用来导入另一个注解配置类</li>
<li>@ImportResource    用来导入xml配置文件</li>
</ul>
<p>注：</p>
<p>打上了@Component 注解的类型，它在Spring容器中的默认名字是 类的简名， 打上了@Bean注解的方法，它在Spring容器中的默认名字是 方法名。</p>
<h3 id="JAVAEE规范中的依赖注入和Spring-依赖注入"><a href="#JAVAEE规范中的依赖注入和Spring-依赖注入" class="headerlink" title="JAVAEE规范中的依赖注入和Spring 依赖注入"></a>JAVAEE规范中的依赖注入和Spring 依赖注入</h3><ol>
<li><p>官方包：javax.annotation 和  javax.inject 包</p>
<p>提供了 @Resource 注解，这个注解可以通过名字来精确定位目标对象。</p>
<p>它相当于：@Autowired + @Qualifier</p>
</li>
</ol>
<h3 id="Spring的测试"><a href="#Spring的测试" class="headerlink" title="Spring的测试"></a>Spring的测试</h3><blockquote>
<p>要想使用Spring 测试环境，需要准备如下的依赖：</p>
<ol>
<li>spring-test  依赖</li>
<li>testng 或 junit 的依赖【这两个二选一， spring-test 都支持】</li>
</ol>
</blockquote>
<h3 id="测试代码的编写"><a href="#测试代码的编写" class="headerlink" title="测试代码的编写"></a>测试代码的编写</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pxxy.toturial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> config.SpringTutorialConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.testng.AbstractTestNGSpringContextTests;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> yejf</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = SpringTutorialConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">BaseTests</span> <span class="keyword">extends</span> <span class="title">AbstractTestNGSpringContextTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//nothing at all</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：</p>
<p>@ContextConfiguration 注解是用来加载 spring的配置文件或配置类的。通过locations属性来加载配置文件，通过classes 属性来加载配置类</p>
<p>继承<code>AbstractTestNGSpringContextTests</code>的目的是为了把 Spring 容器整合到 testng的测试上下文中，以便我们在测试环境中直接注入目标对象。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/spring%E6%A1%86%E6%9E%B6-day01/" data-id="ckcmpx87j001jcghceeis8g3d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/14/hello-world/" class="article-date">
  <time datetime="2020-07-14T09:28:48.182Z" itemprop="datePublished">2020-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/14/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/14/hello-world/" data-id="ckcmpx87g001fcghcc8xv7e3n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-MyBatis过程和原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/14/MyBatis%E8%BF%87%E7%A8%8B%E5%92%8C%E5%8E%9F%E7%90%86/" class="article-date">
  <time datetime="2020-07-14T09:13:15.341Z" itemprop="datePublished">2020-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/14/MyBatis%E8%BF%87%E7%A8%8B%E5%92%8C%E5%8E%9F%E7%90%86/">MyBatis过程和原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="MyBatis过程和原理"><a href="#MyBatis过程和原理" class="headerlink" title="MyBatis过程和原理"></a>MyBatis过程和原理</h2><h4 id="传统流程："><a href="#传统流程：" class="headerlink" title="传统流程："></a>传统流程：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		InputStream inputStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">		SqlSessionFactory factory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">		SqlSession sqlSession = factory.openSession();</span><br><span class="line">		String name = <span class="string">"tom"</span>;</span><br><span class="line">		List&lt;User&gt; list = sqlSession.selectList(<span class="string">"com.demo.mapper.UserMapper.getUserByName"</span>,params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建SqlSessionFactoryBuilder对象，调用build(inputstream)方法读取并解析配置文件，返回SqlSessionFactory对象</li>
<li>由SqlSessionFactory创建SqlSession 对象，没有手动设置的话事务默认开启</li>
<li>调用SqlSession中的api，传入Statement Id和参数，内部进行复杂的处理，最后调用jdbc执行SQL语句，封装结果返回。</li>
</ul>
<h4 id="MyBatis原理分析："><a href="#MyBatis原理分析：" class="headerlink" title="MyBatis原理分析："></a>MyBatis原理分析：</h4><p>解析配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InputStream inputStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line"><span class="comment">//这一行代码正是初始化工作的开始。</span></span><br><span class="line">SqlSessionFactory factory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br></pre></td></tr></table></figure>

<p>源码分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.我们最初调用的build</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//调用了重载方法</span></span><br><span class="line">    <span class="keyword">return</span> build(inputStream, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.调用的重载方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//  XMLConfigBuilder是专门解析mybatis的配置文件的类</span></span><br><span class="line">      XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">      <span class="comment">//这里又调用了一个重载方法。parser.parse()的返回值是Configuration对象</span></span><br><span class="line">      <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error building SqlSession."</span>, e);</span><br><span class="line">    &#125; <span class="comment">//省略部分代码</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中的Configuration先对XML配置中信息进行封装</p>
<p>大概如下图<img src="C:%5CUsers%5CQI_Kran%5CDesktop%5C20190607110727998.png!%5B20190607110727998%5D(C:%5CUsers%5CQI_Kran%5CDesktop%5C20190607110727998.png" alt="20190607110727998"></p>
<p>下面的源码详细的列出了 XML配置中的一些存在的标签</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在创建XMLConfigBuilder时，它的构造方法中解析器XPathParser已经读取了配置文件</span></span><br><span class="line"><span class="comment">//3. 进入XMLConfigBuilder 中的 parse()方法。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Configuration <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Each XMLConfigBuilder can only be used once."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    parsed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//parser是XPathParser解析器对象，读取节点内数据，&lt;configuration&gt;是MyBatis配置文件中的顶层标签</span></span><br><span class="line">    parseConfiguration(parser.evalNode(<span class="string">"/configuration"</span>));</span><br><span class="line">    <span class="comment">//最后返回的是Configuration 对象</span></span><br><span class="line">    <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//4. 进入parseConfiguration方法</span></span><br><span class="line"><span class="comment">//此方法中读取了各个标签内容并封装到Configuration中的属性中。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//issue #117 read properties first</span></span><br><span class="line">      propertiesElement(root.evalNode(<span class="string">"properties"</span>));</span><br><span class="line">      Properties settings = settingsAsProperties(root.evalNode(<span class="string">"settings"</span>));</span><br><span class="line">      loadCustomVfs(settings);</span><br><span class="line">      loadCustomLogImpl(settings);</span><br><span class="line">      typeAliasesElement(root.evalNode(<span class="string">"typeAliases"</span>));</span><br><span class="line">      pluginElement(root.evalNode(<span class="string">"plugins"</span>));</span><br><span class="line">      objectFactoryElement(root.evalNode(<span class="string">"objectFactory"</span>));</span><br><span class="line">      objectWrapperFactoryElement(root.evalNode(<span class="string">"objectWrapperFactory"</span>));</span><br><span class="line">      reflectorFactoryElement(root.evalNode(<span class="string">"reflectorFactory"</span>));</span><br><span class="line">      settingsElement(settings);</span><br><span class="line">      <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span><br><span class="line">      environmentsElement(root.evalNode(<span class="string">"environments"</span>));</span><br><span class="line">      databaseIdProviderElement(root.evalNode(<span class="string">"databaseIdProvider"</span>));</span><br><span class="line">      typeHandlerElement(root.evalNode(<span class="string">"typeHandlers"</span>));</span><br><span class="line">      mapperElement(root.evalNode(<span class="string">"mappers"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing SQL Mapper Configuration. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XML文件解析结束后，回归到前面的步骤2即 build方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5. 调用的重载方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建了DefaultSqlSessionFactory对象，传入Configuration对象。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSessionFactory(config);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>获得SqlSessionFactory后 则开始调用  openSession方法了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//6. 进入openSession方法。</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SqlSession <span class="title">openSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="comment">//getDefaultExecutorType()传递的是SimpleExecutor</span></span><br><span class="line">    <span class="keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//7. 进入openSessionFromDataSource。</span></span><br><span class="line"><span class="comment">//ExecutorType 为Executor的类型，TransactionIsolationLevel为事务隔离级别，autoCommit是否开启事务</span></span><br><span class="line"><span class="comment">//openSession的多个重载方法可以指定获得的SeqSession的Executor类型和事务的处理</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SqlSession <span class="title">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span> </span>&#123;</span><br><span class="line">    Transaction tx = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> Environment environment = configuration.getEnvironment();</span><br><span class="line">      <span class="keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      <span class="comment">//根据参数创建指定类型的Executor</span></span><br><span class="line">      <span class="keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="comment">//返回的是DefaultSqlSession</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error opening session.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>执行SqlSession的Api selectList（）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//8.进入selectList方法，多个重载方法。</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">selectList</span><span class="params">(String statement)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.selectList(statement, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">selectList</span><span class="params">(String statement, Object parameter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.selectList(statement, parameter, RowBounds.DEFAULT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//根据传入的全限定名+方法名从映射的Map中取出MappedStatement对象</span></span><br><span class="line">      MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">      <span class="comment">//调用Executor中的方法处理</span></span><br><span class="line">      <span class="keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error querying database.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>MappednStatement</p>
<ul>
<li>作用：MappedStatement与Mapper配置文件中的一个select/update/insert/delete节点相对应。mapper中配置的标签都被封装到了此对象中，主要用途是描述一条SQL语句。</li>
<li>初始化过程：回顾刚开始介绍的加载配置文件的过程中，会对mybatis-config.xml中的各个标签都进行解析，其中有 mappers标签用来引入<code>mapper.xml文件</code>或者配置<code>mapper接口</code>的目录。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">resultType</span>=<span class="string">"user"</span> &gt;</span></span><br><span class="line">   select * from user where id=#&#123;id&#125;</span><br><span class="line"> <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样的一个select标签会在初始化配置文件时被解析封装成一个MappedStatement对象，然后存储在Configuration对象的mappedStatements属性中，mappedStatements 是一个HashMap，存储时key = 全限定类名 + 方法名，value = 对应的MappedStatement对象。</p>
<p>在configuration对应的属性为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, MappedStatement&gt; mappedStatements = <span class="keyword">new</span> StrictMap&lt;MappedStatement&gt;(<span class="string">"Mapped Statements collection"</span>)</span><br></pre></td></tr></table></figure>

<p>在XMLConfiguratoin中的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 省略其他标签的处理</span></span><br><span class="line">    mapperElement(root.evalNode(<span class="string">"mappers"</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing SQL Mapper Configuration. Cause: "</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入executor.query()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此方法在SimpleExecutor的父类BaseExecutor中实现</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">	<span class="comment">//根据传入的参数动态获得SQL语句，最后返回用BoundSql对象表示</span></span><br><span class="line">    BoundSql boundSql = ms.getBoundSql(parameter);</span><br><span class="line">    <span class="comment">//为本次查询创建缓存的Key</span></span><br><span class="line">    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">    <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//进入query的重载方法中</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">"executing a query"</span>).object(ms.getId());</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">"Executor was closed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">      clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      queryStack++;</span><br><span class="line">      list = resultHandler == <span class="keyword">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// 如果缓存中没有本次查找的值，那么从数据库中查询</span></span><br><span class="line">        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">        deferredLoad.load();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// issue #601</span></span><br><span class="line">      deferredLoads.clear();</span><br><span class="line">      <span class="keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">        <span class="comment">// issue #482</span></span><br><span class="line">        clearLocalCache();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从数据库查询</span></span><br><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 查询的方法</span></span><br><span class="line">      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      localCache.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将查询结果放入缓存</span></span><br><span class="line">    localCache.putObject(key, list);</span><br><span class="line">    <span class="keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">      localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SimpleExecutor中实现父类的doQuery抽象方法</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Configuration configuration = ms.getConfiguration();</span><br><span class="line">      <span class="comment">// 传入参数创建StatementHanlder对象来执行查询</span></span><br><span class="line">      StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="comment">// 创建jdbc中的statement对象</span></span><br><span class="line">      stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">      <span class="comment">// StatementHandler进行处理</span></span><br><span class="line">      <span class="keyword">return</span> handler.query(stmt, resultHandler);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Statement的方法</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Statement <span class="title">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Statement stmt;</span><br><span class="line">    <span class="comment">//条代码中的getConnection方法经过重重调用最后会调用openConnection方法，从连接池中获得连接。</span></span><br><span class="line">    Connection connection = getConnection(statementLog);</span><br><span class="line">    stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">    handler.parameterize(stmt);</span><br><span class="line">    <span class="keyword">return</span> stmt;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//从连接池获得连接的方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">openConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(<span class="string">"Opening JDBC Connection"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从连接池获得连接</span></span><br><span class="line">    connection = dataSource.getConnection();</span><br><span class="line">    <span class="keyword">if</span> (level != <span class="keyword">null</span>) &#123;</span><br><span class="line">      connection.setTransactionIsolation(level.getLevel());</span><br><span class="line">    &#125;</span><br><span class="line">    setDesiredAutoCommit(autoCommit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//进入StatementHandler进行处理的query，StatementHandler中默认的是PreparedStatementHandler</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    <span class="comment">//原生jdbc的执行</span></span><br><span class="line">    ps.execute();</span><br><span class="line">    <span class="comment">//处理结果返回。</span></span><br><span class="line">    <span class="keyword">return</span> resultSetHandler.handleResultSets(ps);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口的方法即getMapper方法"><a href="#接口的方法即getMapper方法" class="headerlink" title="接口的方法即getMapper方法"></a>接口的方法即getMapper方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//前三步都相同</span></span><br><span class="line">		InputStream inputStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">		SqlSessionFactory factory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">		SqlSession sqlSession = factory.openSession();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//这里不再调用SqlSession 的api，而是获得了接口对象，调用接口中的方法。</span></span><br><span class="line">		UserMapper mapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;User&gt; list = mapper.getUserByName(<span class="string">"tom"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法采用动态代理的方式来实现。</p>
<p>开始之前介绍一下MyBatis初始化时对接口的处理：MapperRegistry是Configuration中的一个属性，它内部维护一个HashMap用于存放mapper接口的<code>工厂类</code>，每个接口对应一个工厂类。mappers中可以配置接口的包路径，或者某个具体的接口类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 将包内的映射器接口实现全部注册为映射器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"com.demo.mapper.UserMapper"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.demo.mapper"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当解析mappers标签时，它会判断解析到的是mapper配置文件时，会再将对应配置文件中的增删改查标签一 一封装成MappedStatement对象，存入mappedStatements中。（上文介绍了）</li>
<li>当判断解析到接口时，会创建此接口对应的MapperProxyFactory对象，存入HashMap中，key = 接口的字节码对象，value = 此接口对应的MapperProxyFactory对象。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MapperRegistry类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperRegistry</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Configuration config;</span><br><span class="line">  <span class="comment">//这个类中维护一个HashMap存放MapperProxyFactory</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//解析到接口时添加接口工厂类的方法</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type.isInterface()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasMapper(type)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is already known to the MapperRegistry."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//重点在这行，以接口类的class对象为key，value为其对应的工厂对象，构造方法中指定了接口对象</span></span><br><span class="line">        knownMappers.put(type, <span class="keyword">new</span> MapperProxyFactory&lt;&gt;(type));</span><br><span class="line">        <span class="comment">// It's important that the type is added before the parser is run</span></span><br><span class="line">        <span class="comment">// otherwise the binding may automatically be attempted by the</span></span><br><span class="line">        <span class="comment">// mapper parser. If the type is already known, it won't try.</span></span><br><span class="line">        MapperAnnotationBuilder parser = <span class="keyword">new</span> MapperAnnotationBuilder(config, type);</span><br><span class="line">        parser.parse();</span><br><span class="line">        loadCompleted = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">          knownMappers.remove(type);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入SqlSession.getMapper中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DefaultSqlSession中的getMapper</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> configuration.&lt;T&gt;getMapper(type, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//configuration中的给getMapper</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MapperRegistry中的getMapper</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//从MapperRegistry中的HashMap中拿MapperProxyFactory</span></span><br><span class="line">    <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 通过动态代理工厂生成示例。</span></span><br><span class="line">      <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MapperProxyFactory类中的newInstance方法</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line"> 	<span class="comment">// 创建了JDK动态代理的Handler类</span></span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="comment">// 调用了重载方法</span></span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MapperProxy类，实现了InvocationHandler接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//省略部分源码	</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构造，传入了SqlSession，说明每个session中的代理对象的不同的！</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperProxy</span><span class="params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlSession = sqlSession;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    <span class="keyword">this</span>.methodCache = methodCache;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//省略部分源码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重载的方法，由动态代理创建新示例返回。</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在动态代理返回了示例后，我们就可以直接调用mapper类中的方法了，说明在MapperProxy中的invoke方法中已经为我们实现了方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//判断调用是是不是Object中定义的方法，toString，hashCode这类非。是的话直接放行。</span></span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    <span class="comment">// 重点在这：MapperMethod最终调用了执行的方法</span></span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="comment">//判断mapper中的方法类型，最终调用的还是SqlSession中的方法</span></span><br><span class="line">    <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line">      <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">    	Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SELECT:</span><br><span class="line">        <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">          <span class="keyword">if</span> (method.returnsOptional() &amp;&amp;</span><br><span class="line">              (result == <span class="keyword">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">            result = Optional.ofNullable(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Mapper method '"</span> + command.getName()</span><br><span class="line">          + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + method.getReturnType() + <span class="string">")."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/14/MyBatis%E8%BF%87%E7%A8%8B%E5%92%8C%E5%8E%9F%E7%90%86/" data-id="ckcmpx85k0005cghc71gpe4g8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/15/SpringMVC-%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B5%8B%E8%AF%95/">SpringMVC-控制器测试</a>
          </li>
        
          <li>
            <a href="/2020/07/15/Spring+mybatis%E6%95%B4%E5%90%88/">Spring+mybatis整合</a>
          </li>
        
          <li>
            <a href="/2020/07/15/Spring%20MVC-3/">Spring MVC-3</a>
          </li>
        
          <li>
            <a href="/2020/07/15/spring%20MVC-2/">spring MVC-2</a>
          </li>
        
          <li>
            <a href="/2020/07/15/Spring%20MVC-1/">Spring MVC-1</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 QiKran<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>